# 策略條件完整指南

> 整合自舊版 `backtest_options.md`、`risk_assessment.md`、`callback_logic.md`
> 最後更新：2026-02

---

## 一、概覽

FinPack 的策略由三個維度的條件組合決定：

| 維度 | 說明 | 邏輯 |
|------|------|------|
| **買入條件** | 決定哪些股票可以買入 | 交集（AND）：所有啟用條件都必須滿足 |
| **賣出條件** | 決定何時賣出持倉 | 聯集（OR）：任一條件滿足即觸發 |
| **再平衡策略** | 決定如何投入資金 | 單選：一次只選一種策略 |

---

## 二、買入條件（buy_conditions）

### 2.1 買入範圍條件（複選）

| key | 說明 | 主要參數 | 風險特性 |
|-----|------|---------|---------|
| `sharpe_rank` | Sharpe Ratio 排名前 N 名 | `top_n`（預設 15） | 基礎過濾，熊市仍可能買入 |
| `sharpe_threshold` | Sharpe Ratio ≥ 門檻值 | `threshold`（預設 1.0） | **強過濾**，熊市自動停買 |
| `sharpe_streak` | 連續 N 天 Sharpe 在 Top-M 內 | `days`（3）、`top_n`（10） | **強過濾**，過濾假突破 |

### 2.2 成長動能條件（複選）

| key | 說明 | 主要參數 | 風險特性 |
|-----|------|---------|---------|
| `growth_rank` | Growth（排名變化）前 N 名 | `top_n`（預設 7） | 追求短期動能，熊市風險高 |
| `growth_streak` | 連續 N 天 Growth 排名在前 P% | `days`（2）、`percentile`（30） | 驗證持續動能，過濾假突破 |

### 2.3 選股排序條件（複選，影響買入順序）

| key | 說明 | 主要參數 | 風險特性 |
|-----|------|---------|---------|
| `sort_sharpe` | 候選股按 Sharpe 降序排列 | — | 集中選最強 |
| `sort_industry` | 每個產業最多選 N 檔（round-robin） | `per_industry`（預設 2） | 產業分散，降低集中風險 |

### 2.4 買入條件風險矩陣

| # | sharpe_rank | sharpe_threshold | sharpe_streak | growth_rank | growth_streak | sort_sharpe | sort_industry | 風險 | 說明 |
|---|:-----------:|:----------------:|:-------------:|:-----------:|:-------------:|:-----------:|:-------------:|:----:|------|
| 1 | ✗ | ✗ | ✗ | — | — | — | — | 🔴 高 | ⚠️ 請至少選一個買入範圍條件 |
| 2 | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ | ✗ | ⚖️ 平衡 | 基礎過濾，建議配合成長/選股條件 |
| 3 | ✗ | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ | 🟢 低 | 🛡️ 強過濾，熊市自動停買 |
| 4 | ✗ | ✗ | ✓ | ✗ | ✗ | ✗ | ✗ | 🟢 低 | 🛡️ 強過濾，熊市自動停買 |
| 5 | ✓ | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ | 🟢 低 | 🛡️ 多重強過濾 |
| 6 | ✓ | ✗ | ✓ | ✗ | ✗ | ✗ | ✗ | 🟢 低 | 🛡️ 多重強過濾 |
| 7 | ✓ | ✓ | ✓ | ✗ | ✗ | ✗ | ✗ | 🟢 低 | 🛡️ 完整強過濾 |
| 8 | ✓ | ✗ | ✗ | ✓ | ✗ | ✓ | ✗ | 🔴 高 | ⚠️ 牛市最佳但熊市高風險 |
| 9 | ✓ | ✗ | ✗ | ✓ | ✗ | ✗ | ✓ | 🔴 高 | ⚠️ growth_rank 熊市追假反彈 |
| 10 | ✓ | ✗ | ✗ | ✓ | ✗ | ✗ | ✗ | 🔴 高 | ⚠️ growth_rank 熊市追假反彈 |
| 11 | ✓ | ✗ | ✗ | ✗ | ✓ | ✗ | ✓ | ⚖️ 平衡 | ⭐ **全市場最平衡（預設）** |
| 12 | ✓ | ✗ | ✗ | ✗ | ✓ | ✓ | ✗ | ⚖️ 平衡 | 穩健策略 |
| 13 | ✓ | ✗ | ✗ | ✗ | ✓ | ✗ | ✗ | ⚖️ 平衡 | 穩健策略 |
| 14 | ✓ | ✗ | ✗ | ✗ | ✗ | ✗ | ✓ | ⚖️ 平衡 | 分散策略 |
| 15 | ✓ | ✗ | ✗ | ✗ | ✗ | ✓ | ✗ | ⚖️ 平衡 | 中性策略 |
| 16 | * | ✓ | * | ✗ | ✓ | ✗ | ✓ | 🟢 低 | 🛡️ **熊市最安全組合** |
| 17 | * | ✓ | * | ✓ | ✗ | * | * | 🟢 低 | 🛡️ 強過濾保護 |
| 18 | * | * | ✓ | ✓ | ✗ | * | * | 🟢 低 | 🛡️ 強過濾保護 |
| 19 | * | ✓ | * | ✗ | ✓ | ✓ | ✗ | 🟢 低 | 🛡️ 強過濾保護 |
| 20 | * | ✓ | * | ✗ | ✗ | ✗ | ✓ | 🟢 低 | 🛡️ 強過濾保護 |

> **圖例**：✓ = 選中、✗ = 未選中、* = 任意（選或不選皆可）、— = 不適用

### 2.5 推薦買入策略

| 市場環境 | 建議組合 | 風險 |
|---------|---------|:----:|
| 🐂 牛市進取 | `sharpe_rank` + `growth_rank` + `sort_sharpe` | 🔴 高 |
| ⚖️ 全天候平衡（預設） | `sharpe_rank` + `growth_streak` + `sort_industry` | ⚖️ 平衡 |
| 🐻 熊市防禦 | `sharpe_threshold`/`sharpe_streak` + `growth_streak` + `sort_industry` | 🟢 低 |

---

## 三、賣出條件（sell_conditions）

所有賣出條件採聯集（OR）：任一條件滿足即觸發賣出。

| key | 觸發邏輯 | 主要參數 | 說明 |
|-----|---------|---------|------|
| `sharpe_fail` | 連續 `periods` 個再平衡日 Sharpe 排名 > `top_n` | `periods`（2）、`top_n`（15） | 品質性下降：持股 Sharpe 長期失格 |
| `growth_fail` | 最近 `days` 天 Growth 均值 < `threshold` | `days`（5）、`threshold`（0） | 動能衰退：成長連續為負 |
| `not_selected` | 連續 `periods` 個再平衡日未被買入條件選中 | `periods`（3） | 主動淘汰：不再符合買入標準 |
| `drawdown` | 從買入價下跌超過 `threshold` | `threshold`（0.40 = 40%） | 價格止損：絕對虧損保護 |
| `weakness` | 連續 `periods` 個再平衡日 Sharpe 排名 > `rank_k` | `rank_k`（20）、`periods`（3） | 相對弱勢：長期排名落後 |

### 賣出條件風險等級

| 風險 | 典型配置 | 說明 |
|:----:|---------|------|
| 🔴 高 | 無任何賣出條件 | 永不止損，虧損無限擴大 |
| ⚖️ 平衡 | 僅 `sharpe_fail` 或僅 `drawdown` | 單一保護，可能漏網 |
| 🟢 低 | `sharpe_fail` + `drawdown`（預設） | 品質+價格雙重保護 |

---

## 四、再平衡策略（rebalance_strategy）

控制何時及如何買入候選股（單選）。

| 策略 type | 說明 | 主要參數 | 風險等級 |
|-----------|------|---------|---------|
| `immediate` | 有空間立即用固定金額買入 | — | 🔴 高（全額進場） |
| `batch` | 每次只用現金的 `batch_ratio` 比例投入 | `batch_ratio`（0.20） | ⚖️ 平衡（分批平滑） |
| `delayed` | Top-N 平均 Sharpe > `sharpe_threshold` 才買入 | `top_n`（5）、`sharpe_threshold`（0） | 🟢 低（等待確認） |
| `concentrated` | Top-K 領先次群超過 `lead_margin` 才買入 | `concentrate_top_k`（3）、`lead_margin`（0.30） | 🔴 高（集中押注） |
| `none` | 買入後不主動再平衡（只賣不買） | — | 🟢 低（保留現金） |

---

## 五、綜合風險評估矩陣

### 5.1 單維度風險分數

| 維度 | 低（1分） | 平衡（2分） | 高（3分） |
|------|-----------|------------|----------|
| 買入 | 啟用強過濾（`sharpe_threshold`/`sharpe_streak`） | 基礎過濾 + 連續動能 + 產業分散 | 僅 `sharpe_rank` + `growth_rank` + `sort_sharpe` |
| 賣出 | 2個以上賣出條件 | 1個賣出條件 | 無賣出條件 |
| 再平衡 | `delayed` / `none` | `batch` | `immediate` / `concentrated` |

**綜合評級**：
- 3~4 分 → 🟢 低風險
- 5~6 分 → ⚖️ 平衡
- 7~9 分 → 🔴 高風險

### 5.2 完整組合矩陣

| # | 買入 | 賣出 | 再平衡 | 總分 | 評級 | 策略特性 |
|:-:|:----:|:----:|:-----:|:----:|:----:|---------|
| 1 | 🟢 | 🟢 | 🟢 | 3 | 🟢 低 | 🛡️ **極度防禦**：熊市最安全，牛市報酬有限 |
| 2 | 🟢 | 🟢 | ⚖️ | 4 | 🟢 低 | 🛡️ **熊市推薦**：強過濾 + 分批投入 |
| 3 | ⚖️ | 🟢 | 🟢 | 4 | 🟢 低 | 🛡️ 基礎選股 + 完整保護 + 保守投入 |
| 4 | 🟢 | ⚖️ | 🟢 | 4 | 🟢 低 | 強過濾 + 單一保護 + 保守投入 |
| 5 | ⚖️ | 🟢 | ⚖️ | 5 | ⚖️ | ⭐ **全天候推薦（預設）**：牛熊兼顧 |
| 6 | 🟢 | 🟢 | 🔴 | 5 | ⚖️ | 強過濾 + 完整保護 + 積極投入 |
| 7 | ⚖️ | ⚖️ | ⚖️ | 6 | ⚖️ | 三維度皆平衡，適合多數投資者 |
| 8 | 🔴 | 🟢 | 🟢 | 5 | ⚖️ | 進取選股 + 完整保護 + 保守投入 |
| 9 | 🟢 | 🔴 | ⚖️ | 6 | ⚖️ | ⚠️ 強過濾但無賣出保護 |
| 10 | ⚖️ | 🔴 | ⚖️ | 7 | 🔴 高 | ⚠️ 無賣出保護，虧損可能擴大 |
| 11 | 🔴 | ⚖️ | ⚖️ | 7 | 🔴 高 | ⚠️ 進取選股 + 單一保護，熊市危險 |
| 12 | ⚖️ | ⚖️ | 🔴 | 7 | 🔴 高 | ⚠️ 全額進場，擇時風險高 |
| 13 | 🔴 | 🟢 | 🔴 | 7 | 🔴 高 | ⚠️ 進取兩端，熊市危險 |
| 14 | 🔴 | 🔴 | ⚖️ | 8 | 🔴 高 | 🚨 進取選股 + 無保護 |
| 15 | ⚖️ | 🔴 | 🔴 | 8 | 🔴 高 | 🚨 無賣出保護 + 全額進場 |
| 16 | 🔴 | ⚖️ | 🔴 | 8 | 🔴 高 | 🚨 牛市最佳但熊市致命 |
| 17 | 🔴 | 🔴 | 🔴 | 9 | 🔴 高 | 🚨 **極度激進**，僅適合確認牛市 |

---

## 六、典型策略組合

### 🐻 熊市防禦策略

| 維度 | 配置 | 風險 |
|------|------|:----:|
| 買入 | `sharpe_threshold` + `growth_streak` + `sort_industry` | 🟢 低 |
| 賣出 | `sharpe_fail` + `not_selected` + `drawdown` | 🟢 低 |
| 再平衡 | `delayed` 或 `batch` | 🟢 低 |
| **綜合** | | **🟢 低** |

特性：強過濾確保熊市自動停買，三重賣出防止虧損擴大，等待市場轉強。

### ⚖️ 全天候平衡策略（系統預設）

| 維度 | 配置 | 風險 |
|------|------|:----:|
| 買入 | `sharpe_rank` + `growth_streak` + `sort_industry` | ⚖️ 平衡 |
| 賣出 | `sharpe_fail` + `drawdown` | 🟢 低 |
| 再平衡 | `batch` | ⚖️ 平衡 |
| **綜合** | | **⚖️ 平衡** |

特性：基礎過濾 + 連續動能驗證 + 產業分散 + 品質/價格雙重保護 + 分批投入。適合大多數投資者。

### 🐂 牛市進取策略

| 維度 | 配置 | 風險 |
|------|------|:----:|
| 買入 | `sharpe_rank` + `growth_rank` + `sort_sharpe` | 🔴 高 |
| 賣出 | `sharpe_fail` + `drawdown` | 🟢 低 |
| 再平衡 | `immediate` 或 `concentrated` | 🔴 高 |
| **綜合** | | **🔴 高** |

特性：追漲集中選股，最大化牛市參與度。仍保留賣出保護。⚠️ 僅適合確認牛市環境。

---

## 七、條件詳細說明

### 7.1 sharpe_rank 買入條件

**邏輯**：當日股票 Sharpe Ratio 排名（全市場或指定市場）在前 `top_n` 名內才列為候選。

- 排名每日重新計算（以 252 日滾動 Sharpe 為基準）
- 熊市環境中，所有股票 Sharpe 仍可能為正，**不會自動停買**
- 適合作為基礎篩選，搭配其他條件使用

### 7.2 sharpe_threshold 買入條件

**邏輯**：當日 Sharpe Ratio 值（原始數值，非排名）> `threshold` 才列為候選。

- 熊市時多數股票 Sharpe < 0 或 < 1，**自動停買**（強過濾）
- `threshold = 1.0`（預設）代表需要良好的風險調整報酬

### 7.3 sharpe_streak 買入條件

**邏輯**：過去 `days` 天，每天的 Sharpe 排名都在 `top_n` 以內。

- 過濾短期假突破，要求持續性強勢
- 強過濾效果，熊市反彈通常不持續，自動濾除

### 7.4 growth_rank 買入條件

**邏輯**：當日 Growth（排名變化）在前 `top_n` 名，即排名上升最多的股票。

- 追求「最近幾天上升最快」的股票
- 熊市反彈時 Growth 高但往往不持續，**風險較高**

### 7.5 growth_streak 買入條件

**邏輯**：過去 `days` 天，每天的 Growth 排名都在前 `percentile`% 以內。

- 驗證排名上升的持續性，過濾假突破
- `percentile = 30`：每天排名上升量在前 30%

### 7.6 sort_sharpe 選股條件

**邏輯**：候選股按 Sharpe 從高到低排序，優先買入 Sharpe 最強者。

- 無過濾效果，只影響買入的優先順序
- 容易集中在少數強勢股

### 7.7 sort_industry 選股條件

**邏輯**：使用 round-robin 輪詢方式，每個產業最多選 `per_industry` 檔候選股。

- 強制產業分散，降低單一產業崩盤風險
- 按產業 Sharpe 排序決定輪詢順序

### 7.8 sharpe_fail 賣出條件

**邏輯**：在過去 `periods` 個再平衡日中，Sharpe 排名都 > `top_n`，則賣出。

- 品質性淘汰：持股長期不再是市場強者
- `periods = 2`、`top_n = 15`（預設）

### 7.9 growth_fail 賣出條件

**邏輯**：過去 `days` 天的 Growth 平均值 < `threshold`，則賣出。

- 動能衰退：持股排名持續下滑
- `days = 5`、`threshold = 0`（預設）

### 7.10 not_selected 賣出條件

**邏輯**：連續 `periods` 個再平衡日未被買入條件選中，則賣出。

- 主動淘汰：不再符合目前選股標準

### 7.11 drawdown 賣出條件

**邏輯**：從**買入價**（或歷史最高價）回撤超過 `threshold`，則賣出。

- 絕對止損保護
- `threshold = 0.40`（預設 40% 停損）

### 7.12 weakness 賣出條件

**邏輯**：連續 `periods` 個再平衡日 Sharpe 排名 > `rank_k`，則賣出。

- 相對弱勢淘汰：長期排名落後市場

---

## 八、簡化風險規則

| 條件組合 | 風險 | 說明 |
|---------|:----:|------|
| 無買入範圍條件 | 🔴 高 | 必須至少選一個買入範圍條件 |
| `sharpe_threshold`/`streak` + `growth_streak` + `sort_industry` | 🟢 低 | 熊市最安全組合 |
| 有強過濾 + 任意成長/選股 | 🟢 低 | 強過濾保守策略 |
| 僅 `sharpe_rank` + `growth_rank` + `sort_sharpe` | 🔴 高 | 牛市進取但熊市危險 |
| 僅 `sharpe_rank` + `growth_rank` + 任意 | 🔴 高 | `growth_rank` 熊市追反彈風險 |
| 僅 `sharpe_rank` + `growth_streak` + 任意 | ⚖️ 平衡 | `growth_streak` 連續動能過濾假突破 |
| 僅 `sharpe_rank` + 任意 + `sort_industry` | ⚖️ 平衡 | 產業分散降低集中風險 |
